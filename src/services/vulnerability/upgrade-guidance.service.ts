import { blackDuckClient } from "../../client/blackduck-client.js";
import {
  buildGuidance,
  extractComponentIdsFromPath,
} from "./upgrade-guidance.service.utils.js";

interface DependencyAnalysis {
  dependencyType: "DIRECT" | "TRANSITIVE";
  guidanceComponentId: string;
  guidanceComponentVersionId: string;
  guidanceOriginId: string;
}

export type UpgradeGuidance = {
  shortTerm: {
    upgradeFrom: string;
    upgradeTo: string;
  };
  longTerm: {
    upgradeFrom: string;
    upgradeTo: string;
  };
};

export async function getUpgradeGuidance(
  projectId: string,
  projectVersionId: string,
  originId: string,
): Promise<UpgradeGuidance> {
  const {
    dependencyType,
    guidanceComponentId,
    guidanceComponentVersionId,
    guidanceOriginId,
  } = await analyzeDependencyType(projectId, projectVersionId, originId);

  const guidance = await fetchUpgradeGuidance(
    dependencyType,
    guidanceComponentId,
    guidanceComponentVersionId,
    guidanceOriginId,
  );

  return buildGuidance(guidance);
}

async function fetchUpgradeGuidance(
  dependencyType: "DIRECT" | "TRANSITIVE",
  componentId: string,
  componentVersionId: string,
  originId: string,
): Promise<any> {
  if (dependencyType === "DIRECT") {
    return await blackDuckClient.getUpgradeGuidance(
      componentId,
      componentVersionId,
    );
  } else {
    return await blackDuckClient.getTransitiveUpgradeGuidance(
      componentId,
      componentVersionId,
      originId,
    );
  }
}

async function analyzeDependencyType(
  projectId: string,
  projectVersionId: string,
  originId: string,
): Promise<DependencyAnalysis> {
  let dependencyType: "DIRECT" | "TRANSITIVE" = "DIRECT";
  let guidanceComponentId;
  let guidanceComponentVersionId;
  let guidanceOriginId;

  const dependencyPaths = await blackDuckClient.getDependencyPaths(
    projectId,
    projectVersionId,
    originId,
  );

  if (dependencyPaths.items && dependencyPaths.items.length > 0) {
    const firstItem = dependencyPaths.items[0];
    dependencyType = firstItem.type;

    // Extract component IDs from the dependency path links
    const extractedIds = extractComponentIdsFromPath(firstItem, dependencyType);
    if (extractedIds) {
      guidanceComponentId = extractedIds.componentId;
      guidanceComponentVersionId = extractedIds.componentVersionId;
      if (extractedIds.originId) {
        guidanceOriginId = extractedIds.originId;
      }
    }
  }

  if (!guidanceComponentId) {
    throw new Error("Unable to determine component ID for upgrade guidance.");
  }

  if (!guidanceComponentVersionId) {
    throw new Error(
      "Unable to determine component version ID for upgrade guidance.",
    );
  }

  return {
    dependencyType,
    guidanceComponentId,
    guidanceComponentVersionId,
    guidanceOriginId: guidanceOriginId as string,
  };
}
